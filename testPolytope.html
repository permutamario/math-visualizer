<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polytope Viewer Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .container {
      display: flex;
      gap: 20px;
    }
    
    .controls {
      flex: 1;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    
    .visualization {
      flex: 2;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      min-height: 400px;
      position: relative;
    }
    
    .debug {
      margin-top: 20px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
      white-space: pre-wrap;
      font-family: monospace;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .control {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    select, button {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      padding: 10px;
      margin-top: 10px;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    #debugClear {
      background-color: #f44336;
    }
    
    #debugClear:hover {
      background-color: #d32f2f;
    }
  </style>
</head>
<body>
  <h1>Polytope Viewer Test</h1>
  
  <div class="container">
    <div class="controls">
      <h2>Controls</h2>
      
      <div class="control">
        <label for="visualizationType">Polytope Class:</label>
        <select id="visualizationType">
          <!-- Will be populated dynamically -->
        </select>
      </div>
      
      <button id="reinitButton">Reinitialize Plugin</button>
    </div>
    
    <div class="visualization">
      <h2>Visualization Preview</h2>
      <div id="visualizationPreview">
        <p>Select a visualization type to preview</p>
      </div>
    </div>
  </div>
  
  <h2>Debug Console</h2>
  <button id="debugClear">Clear Debug Output</button>
  <div id="debugOutput" class="debug"></div>
  
  <script>
    // Debug logging function
    function log(message) {
      const debugOutput = document.getElementById('debugOutput');
      const timestamp = new Date().toLocaleTimeString();
      debugOutput.innerHTML += `[${timestamp}] ${message}\n`;
      debugOutput.scrollTop = debugOutput.scrollHeight;
    }
    
    // Simulate the plugin system
    class PluginTest {
      constructor() {
        this.parameters = {
          visualizationType: 'platonic' // Default visualization type
        };
        
        // Simulate visualization types
        this.visualizationTypes = [
          { id: 'platonic', name: 'Platonic Solids' },
          { id: 'permutahedron', name: 'Permutahedron' },
          { id: 'root-polytope', name: 'Root Polytope' },
          { id: 'stellahedron', name: 'Stellahedron' }
        ];
        
        // Keep track of current visualization
        this.currentVisualization = null;
        
        // Initialize UI
        this.initializeUI();
        
        // Call getParameterSchema to test it
        this.getParameterSchema();
        
        // Simulate initialization
        this.initializePlugin();
      }
      
      // Initialize the UI
      initializeUI() {
        // Populate visualization type dropdown
        const visualizationTypeSelect = document.getElementById('visualizationType');
        visualizationTypeSelect.innerHTML = '';
        
        this.visualizationTypes.forEach(vizType => {
          const option = document.createElement('option');
          option.value = vizType.id;
          option.textContent = vizType.name;
          visualizationTypeSelect.appendChild(option);
        });
        
        // Set initial value
        visualizationTypeSelect.value = this.parameters.visualizationType;
        
        // Add event listeners
        visualizationTypeSelect.addEventListener('change', (event) => {
          this.onParameterChanged('visualizationType', event.target.value);
        });
        
        // Reinitialize button
        document.getElementById('reinitButton').addEventListener('click', () => {
          this.initializePlugin();
        });
        
        // Clear debug button
        document.getElementById('debugClear').addEventListener('click', () => {
          document.getElementById('debugOutput').innerHTML = '';
        });
      }
      
      // Simulate getParameterSchema
      getParameterSchema() {
        log(`getParameterSchema called`);
        log(`Current parameters: ${JSON.stringify(this.parameters)}`);
        
        // Use the current visualization type
        const currentType = this.parameters.visualizationType || this.visualizationTypes[0].id;
        
        log(`Current type: ${currentType}`);
        
        // Create visualization type selector options
        const visualizationTypeOptions = this.visualizationTypes.map(vt => ({
          value: vt.id,
          label: vt.name
        }));
        
        log(`Visualization type options: ${JSON.stringify(visualizationTypeOptions)}`);
        
        // Plugin parameter - with current type as default
        const pluginParam = {
          id: 'visualizationType',
          type: 'dropdown',
          label: 'Polytope Class',
          options: visualizationTypeOptions,
          default: currentType  // Default set to current type
        };
        
        log(`Plugin param: ${JSON.stringify(pluginParam)}`);
        
        // In real code, we'd combine with other parameters and return
        // For test purposes, we'll just return this one parameter
        return {
          structural: [pluginParam],
          visual: []
        };
      }
      
      // Simulate onParameterChanged
      onParameterChanged(parameterId, value) {
        log(`onParameterChanged: ${parameterId} = ${value}`);
        log(`Previous value: ${this.parameters[parameterId]}`);
        
        // Store previous value for comparison
        const prevValue = this.parameters[parameterId];
        
        // Update parameter value
        this.parameters[parameterId] = value;
        
        // Special handling for visualization type changes
        if (parameterId === 'visualizationType' && value !== prevValue) {
          log(`Visualization type changing from ${prevValue} to ${value}`);
          
          // Find visualization info
          const vizInfo = this.visualizationTypes.find(vt => vt.id === value);
          
          if (!vizInfo) {
            log(`Error: Visualization type ${value} not found`);
            return;
          }
          
          // Simulate creating and activating visualization
          this.currentVisualization = vizInfo;
          
          // Update preview
          this.updateVisualizationPreview();
          
          // Get parameters after visualization change
          log(`Parameters after visualization change: ${JSON.stringify(this.parameters)}`);
          
          // Simulate building UI controls from schema
          this.buildControlsFromSchema();
          
          return;
        }
      }
      
      // Simulate building controls from schema
      buildControlsFromSchema() {
        log(`buildControlsFromSchema called`);
        
        // Get schema
        const schema = this.getParameterSchema();
        
        // In a real implementation, this would rebuild all controls
        // For this test, we'll just update the visualization type dropdown
        const visualizationTypeSelect = document.getElementById('visualizationType');
        
        // This mimics what happens in UIBuilder.createDropdown
        log(`Setting dropdown value to: ${this.parameters.visualizationType}`);
        visualizationTypeSelect.value = this.parameters.visualizationType;
        
        // Debug: Check if the value was set correctly
        setTimeout(() => {
          log(`Dropdown value after setting: ${visualizationTypeSelect.value}`);
          if (visualizationTypeSelect.value !== this.parameters.visualizationType) {
            log(`WARNING: Dropdown value doesn't match parameter value!`);
            log(`Dropdown options: ${Array.from(visualizationTypeSelect.options).map(o => o.value).join(', ')}`);
          }
        }, 10);
      }
      
      // Simulate initialization
      initializePlugin() {
        log(`Initializing plugin with parameters: ${JSON.stringify(this.parameters)}`);
        
        // Set current visualization based on parameters
        const vizInfo = this.visualizationTypes.find(vt => vt.id === this.parameters.visualizationType);
        if (vizInfo) {
          this.currentVisualization = vizInfo;
          log(`Initial visualization set to: ${vizInfo.name}`);
        } else {
          log(`Warning: Visualization type ${this.parameters.visualizationType} not found, using default`);
          this.currentVisualization = this.visualizationTypes[0];
          this.parameters.visualizationType = this.visualizationTypes[0].id;
        }
        
        // Update visualization preview
        this.updateVisualizationPreview();
        
        // Build controls from schema
        this.buildControlsFromSchema();
      }
      
      // Update visualization preview
      updateVisualizationPreview() {
        const preview = document.getElementById('visualizationPreview');
        
        if (this.currentVisualization) {
          // In a real implementation, this would render the visualization
          // For this test, we'll just show the name
          preview.innerHTML = `
            <h3>${this.currentVisualization.name}</h3>
            <p>Type: ${this.currentVisualization.id}</p>
            <p>This is a simulated preview of the ${this.currentVisualization.name} visualization.</p>
          `;
        } else {
          preview.innerHTML = `<p>No visualization selected</p>`;
        }
      }
    }
    
    // Initialize the test
    document.addEventListener('DOMContentLoaded', () => {
      const test = new PluginTest();
      
      // Store in window for console debugging
      window.pluginTest = test;
      log('Test initialized. You can access the test object in the console as window.pluginTest');
    });
  </script>
</body>
</html>
